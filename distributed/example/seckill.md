# 秒杀活动

- [秒杀活动](#秒杀活动)
    - [技术特点](#技术特点)
    - [高并发系统的关键指标](#高并发系统的关键指标)
    - [设计原则](#设计原则)
    - [动静分离架构](#动静分离架构)
    - [热点数据](#热点数据)
      - [什么是热点数据？](#什么是热点数据)
      - [如何发现热点数据？](#如何发现热点数据)
      - [如何处理热点数据？](#如何处理热点数据)
    - [大流量的高效管控](#大流量的高效管控)
      - [流量分层 + 流量分层控制](#流量分层--流量分层控制)

---

### 技术特点
- 瞬时并发量高
- 并发读写。读多写少
> “短时间内遭遇大流量冲击” 如果没有处理好，则很有可能造成系统吞吐量下降，响应变慢，影响用户体验。甚至可能造成系统彻底不可对外服务。所以需要优化系统，来达到高并发的需求。（硬件、网络、应用、数据库）

### 高并发系统的关键指标
- 响应时间
与用户体验相关，与系统性能相关
- 吞吐量
反映系统的负载能力。单位：请求数/秒 表示从应用角度来衡量；字节数/秒 表示从网络的角度来看
- QPS（每秒请求数）
上线前预估系统QPS，二八原则：百分之八十的流量在20%的时间段内产生的。平均QPS = （一天的请求总数*0.8）/（12*60*60*0.2）。一般还需要计算当天最高QPS。峰值QPS / 单机最高可承受的QPS = 机器数
- TPS（每秒事务数）
1）客户端请求服务端
2）在服务端内部进行业务逻辑处理
3）服务端响应客户端
假设访问一个页面时会请求服务器3次，这样的一次访问会产生1个TPS、3个QPS
- PV（Page view，访问量）
用户对同一个页面的访问次数
- UV（Unique Visitor，独立访客量）
反映一定时间内有多少独立客户端进行了访问
- 网络流量
  - 流入流量：从外部访问服务器所消耗的流量
  - 流出流量：服务器对外响应的流量

### 设计原则
- 数据应尽量少：减少传输的数据，能有效提高cpu利用率。如：简化对应页面的大小；能预热的数据尽量预热；发送请求时只带上最有用的信息；服务端的response指包含最简化的数据；减少外部依赖，能自己做的就自己做
- 请求数应尽量少：将多个静态文件进行合并请求
- 请求路径应尽量短：减少请求节点，降低总的网络传输成本：将依赖性强的应用合并部署在一起，将RPC变成对应的内部方法调用。还可以使用多级缓存来缩短路径
- 尽量使用异步化：消息队列，削峰
- 避免单节点：保证高可用

### 动静分离架构
静态资源和动态数据解耦。
静态资源，尽量缩短用户的请求路径，路径越短，访问速度越快。尽量将静态数据缓存起来。CDN， Squid缓存
动态数据，需要和服务端交互，请求路径越长，速度越慢
“页面静态化”

### 热点数据

#### 什么是热点数据？
在一定时间内被大量用户访问的数据
- 静态热点数据：可以提前预知的数据
- 动态热点数据：不能被提前预知的数据

#### 如何发现热点数据？
静态热点数据，要么可以事先被定义，要么可以根据历史预测出。这种数据可以写入缓存。
动态热点数据，很难发现，有几种建议：
- 使用日志收集组件，实时收集各服务数据
- 将实时收集到的日志信息发送到消息中间件
- 构建一套流式计算系统，实时从消息中间件中消费日志消息
- 流式计算系统对日志信息进行实时流式计算，得到热点数据

#### 如何处理热点数据？
优化、限制、隔离
- 热点数据优化：直接将发现的热点数据写入分布式缓存，根据业务情况对其设置缓存过期时间
- 热点数据限制：不让热点数据抢占其他请求的资源，如线程池隔离技术
- 热点数据隔离：独立部署，使用独立域名，使用独立数据库

### 大流量的高效管控

#### 流量分层 + 流量分层控制
在不同的层级中，尽可能过滤掉无效的请求。到达倒三角最末端的请求，才是最有效的请求。
- CDN层
- 反向代理层（Nginx）：限制用户访问频率，对于有风险的请求，风控可以直接调用Nginx中的Lua风控接口，对其进行封停处理，如禁止某个IP地址或者将请求的UserAgent封停
- 后端服务层
  - 在开发上，代码独立，不要与其他项目合在一起
  - 在部署时，应用独立部署，分散流量，避免不合适的流量影响主体业务
  - 使用独立域名，或者按照一定的URl规则在反向代理层进行路由
  - 做好系统保护和限流，进一步减少不必要的流量
- 数据库层流量限制
  - 如果不是临时的活动，建议使用独立的数据库
  - 将数据库配置成读写分离
  - 尝试去除行锁
