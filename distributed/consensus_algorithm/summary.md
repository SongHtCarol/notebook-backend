# 分布式一致性

- [分布式一致性](#分布式一致性)
  - [什么是分布式一致性问题？](#什么是分布式一致性问题)
  - [一致性解决方案](#一致性解决方案)
  - [paxos 避免脑裂](#paxos-避免脑裂)
    - [一、Paxos 的核心机制](#一paxos-的核心机制)
      - [1. **多数派（Quorum）原则**](#1-多数派quorum原则)
      - [2. **提案编号（Proposal ID）递增**](#2-提案编号proposal-id递增)
      - [3. **两阶段提交（Prepare \& Accept）**](#3-两阶段提交prepare--accept)
    - [二、Paxos 如何避免脑裂？](#二paxos-如何避免脑裂)
      - [1. **网络分区场景**](#1-网络分区场景)
      - [2. **只有多数派分区的提案生效**](#2-只有多数派分区的提案生效)
      - [3. **旧主节点的淘汰**](#3-旧主节点的淘汰)
    - [三、Paxos 的配置建议](#三paxos-的配置建议)
    - [四、Paxos vs. 其他算法（如 Raft）](#四paxos-vs-其他算法如-raft)
    - [五、总结](#五总结)


---
## 什么是分布式一致性问题？
分布式系统需要数据复制
- 为了提高系统可用性，防止单点故障引起系统不可用
- 提高系统整体性能，通过负载均衡，让分布在不同地方的数据副本都能为用户提供服务
分布式环境引入数据复制后，不同数据节点间可能出现，无法依靠应用程序自身解决的数据不一致的情况。

## 一致性解决方案
- Paxos
  - [算法原理](/distributed/consensus_algorithm/paxos/basic.md)
  - [工程应用](/distributed/consensus_algorithm/paxos/apply.md)
- Raft
  - [算法原理](/distributed/consensus_algorithm/raft/basic.md)

## paxos 避免脑裂
在分布式系统中，**Paxos 算法**通过其核心设计有效避免了脑裂（Split Brain）问题。脑裂通常发生在网络分区（Network Partition）时，多个节点同时认为自己是主节点（Leader），导致数据不一致。Paxos 通过以下机制确保系统最终达成一致，避免脑裂：


### 一、Paxos 的核心机制
#### 1. **多数派（Quorum）原则**
- **规则**：Paxos 要求任何提案（Proposal）必须被**半数以上（N/2+1）**的节点接受（Accept）才能生效。
- **作用**：
  - 在网络分区时，最多只有一个分区能形成多数派，只有该分区的提案会被通过。
  - 其他分区因无法达到多数派，无法通过提案，从而避免脑裂。

#### 2. **提案编号（Proposal ID）递增**
- **规则**：每个提案必须附带一个全局递增的唯一编号（如时间戳 + 节点 ID）。
- **作用**：
  - 高编号的提案会覆盖低编号的提案，确保最终只有一个提案被选定。
  - 旧主节点的提案会被新主节点的高编号提案淘汰，避免冲突。

#### 3. **两阶段提交（Prepare & Accept）**
- **阶段 1（Prepare）**：
  - Proposer（提案者）向所有节点广播一个提案编号 `N`，请求承诺（Promise）。
  - 节点会拒绝所有编号小于 `N` 的提案，并返回已接受的最高编号提案。
- **阶段 2（Accept）**：
  - Proposer 收到多数派的承诺后，广播提案内容。
  - 节点接受提案并持久化，当多数派接受后提案生效。


### 二、Paxos 如何避免脑裂？
#### 1. **网络分区场景**
假设一个 5 节点的集群分裂为两个分区：
- **分区 A**：包含 3 个节点（多数派）。
- **分区 B**：包含 2 个节点（少数派）。

#### 2. **只有多数派分区的提案生效**
- **分区 A**：可以形成多数派（3/5 > 半数），提案会被接受并生效。
- **分区 B**：无法形成多数派（2/5 < 半数），提案会被拒绝。
- **结果**：系统最终以分区 A 的提案为准，分区 B 的节点在恢复后会同步数据。

#### 3. **旧主节点的淘汰**
- 若旧主节点位于分区 B（少数派），其低编号提案会被新主节点的高编号提案覆盖。
- 网络恢复后，少数派节点会通过提案编号的比对，自动同步到最新状态。

### 三、Paxos 的配置建议
1. **节点数量为奇数**  
   - 例如 3、5、7 个节点，确保网络分区时最多只有一个分区能形成多数派。
   - 偶数节点（如 4 个）可能导致两个分区各占 2 个节点，均无法形成多数派，导致活锁（Livelock）。

2. **超时机制**  
   - 为提案和心跳设置超时时间，避免因节点故障或网络延迟导致的无限等待。

3. **持久化存储**  
   - 节点必须持久化已接受的提案编号和内容，防止重启后状态不一致。


### 四、Paxos vs. 其他算法（如 Raft）
| **特性**         | Paxos              | Raft               |
|------------------|--------------------|--------------------|
| **脑裂避免**     | 通过多数派和提案编号 | 通过选举 Term 和多数派 |
| **实现复杂度**   | 高（需处理多轮交互） | 低（强 Leader 模型） |
| **适用场景**     | 通用分布式共识      | 易实现的 Leader 驱动场景 |


### 五、总结
- **Paxos 通过多数派原则**确保网络分区时只有一个分区的提案生效。
- **提案编号递增机制**淘汰旧提案，避免多个主节点并存。
- **两阶段提交**保证提案的全局一致性。

Paxos 的设计从根本上避免了脑裂问题，是分布式系统实现强一致性的基石。实际应用中需合理配置节点数量和超时参数，以平衡一致性和可用性。

